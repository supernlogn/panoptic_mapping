<launch>
<!-- ============ Arguments ============ -->
  <arg name="play_rate" default="1"/>
  <arg name="clock_refresh_rate" default="50" />
  <arg name="data_player_refresh_rate" default="100" />
  <arg name="sim_speed_multiplier" default="5" />  
  <arg name="wait" default="false"/>
  <arg name="namespace" default="data"/>
  <arg name="use_detectron" default="false"/>
  <arg name="max_frames" default="1e9"/>
  <arg name="global_frame_name" default="world"/>
  <arg name="sensor_frame_name" default="depth_camera"/>
  <arg name="use_noise" default="true"/>
  <arg name="drift_type" default="severe"/>
  <arg name="use_sim_time" default="false"/>

<!-- ============ Play Data ============ -->
  <param name="use_sim_time" value="$(arg use_sim_time)" />
  
  <node pkg="panoptic_mapping_utils" type="flat_data_player.py" name="flat_data_player" output="screen">
    <param name="data_path" value="$(arg base_path)" />
    <param name="play_rate" value="$(arg play_rate)" />
    <param name="use_detectron" value="$(arg use_detectron)" />
    <param name="global_frame_name" value="$(arg global_frame_name)" />
    <param name="sensor_frame_name" value="$(arg sensor_frame_name)" />
    <param name="wait" value="$(arg wait)" />
    <param name="max_frames" value="$(arg max_frames)" />
    <param name="refresh_rate" value="$(arg data_player_refresh_rate)"/>
    <remap from="~color_image" to="$(arg namespace)/color_image" />
    <remap from="~depth_image" to="$(arg namespace)/depth_image" />
    <remap from="~id_image" to="$(arg namespace)/segmentation_image" />
    <remap from="~labels" to="$(arg namespace)/segmentation_labels" />
    <remap from="~pose" to="$(arg namespace)/pose_ground_truth" />
    <param name="use_noise" value="$(arg use_noise)" />
  </node>

<!-- add noise to the data -->
  <node pkg="panoptic_mapping_utils" type="drift_generator_node" name="drift_generator" output="screen">
    <param name="noisy_pose_topic" value="$(arg namespace)/pose" />
    <param name="ground_truth_Pose_topic" value="$(arg namespace)/pose_ground_truth" />
    <param name="save_noise_file_path" value="/home/ioannis/catkin_ws/src/panoptic_mapping/panoptic_mapping_utils/generated_path.txt" />
    <param name="save_noise_to_file" value="true" />
    <param name="global_frame_name" value="$(arg global_frame_name)" />
    <param name="sensor_frame_name" value="$(arg sensor_frame_name)" />
    <rosparam command="load" file="/home/ioannis/catkin_ws/src/panoptic_mapping/panoptic_mapping_utils/config/drift_$(arg drift_type).yaml" />
  </node>

  <!-- Path visualization -->
  <node pkg="panoptic_mapping_utils" type="path_visualizer.py" name="path_visualizer_noisy" output="screen" if="$(arg use_noise)">
    <remap from="~pose_in" to="$(arg namespace)/pose" />
    <param name="use_arrow" value="false" />
    <param name="length" value="0.5" />
    <param name="use_noise" value="$(arg use_noise)" />
  </node>
  <node pkg="panoptic_mapping_utils" type="path_visualizer.py" name="path_visualizer_gt" output="screen">
    <remap from="~pose_in" to="$(arg namespace)/pose_ground_truth" />
    <param name="use_arrow" value="false" />
    <param name="length" value="0.01" />
    <param name="use_noise" value="$(arg use_noise)" />
    <param name="r" value="0"/>
    <param name="g" value="1"/>
  </node>

  <!-- Use clock provider if use_sim is true -->
  <node pkg="panoptic_mapping_utils" type="sim_time_talker.py" name="SimTimePublisher" output="screen" if="$(arg use_sim_time)">
    <param name="data_path" value="$(arg base_path)" />
    <param name="play_rate" value="$(arg play_rate)" />
    <param name="max_frames" value="$(arg max_frames)" />
    <param name="refresh_rate" value="$(arg clock_refresh_rate)"/>
    <param name="sim_speed_multiplier" value="$(arg sim_speed_multiplier)"/>
  </node>
</launch>
